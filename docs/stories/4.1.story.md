# Story 4.1: Device Flow 인증 서비스 구현

## Story Information
- **Epic:** 4 - GitHub 인증 시스템 개선
- **Story:** 4.1
- **Status:** Draft
- **Created:** 2025-09-02
- **Updated:** 2025-09-02
- **Type:** Brownfield Enhancement
- **Estimated Effort:** 3-5 hours

## Story

**As a** 블로그 사용자,
**I want** GitHub 계정으로 직접 로그인할 수 있는 옵션이 있기를,
**so that** Personal Access Token을 수동으로 생성하고 관리할 필요 없이 더 편리하게 블로그에 접근할 수 있다.

## Acceptance Criteria

1. **Device Flow 시작**
   - WHEN 사용자가 "GitHub로 로그인" 버튼을 클릭할 때
   - THEN GitHub Device Flow가 시작되고 user code와 verification URI가 제공되어야 한다
   - AND 사용자가 GitHub에서 코드를 입력할 수 있는 명확한 안내가 표시되어야 한다

2. **Device Flow 인증 완료**
   - WHEN 사용자가 GitHub에서 코드를 승인하고 권한을 부여할 때
   - THEN 시스템이 자동으로 access token을 받아와서 인증을 완료해야 한다
   - AND 기존 PAT 인증과 동일한 권한 확인 플로우가 실행되어야 한다

3. **인증 상태 관리**
   - WHEN Device Flow 인증이 완료될 때
   - THEN 기존 useGitHubAuthStore의 상태가 올바르게 업데이트되어야 한다
   - AND 토큰이 기존과 동일한 방식으로 암호화되어 저장되어야 한다

4. **사용자 경험**
   - WHEN Device Flow 진행 중일 때
   - THEN 진행 상황과 다음 단계가 명확하게 안내되어야 한다
   - AND 사용자가 프로세스를 취소할 수 있는 옵션이 제공되어야 한다

5. **호환성 유지**
   - WHEN Device Flow 인증이 추가될 때
   - THEN 기존 Personal Access Token 인증 방식도 계속 사용 가능해야 한다
   - AND 두 인증 방식 간 충돌이 발생하지 않아야 한다

## UX/Design Checklist
- [x] PRD UI Design Goals section reviewed - 기존 GitHub 로그인 UI 패턴 활용
- [x] Accessibility requirements (WCAG AA) - 기존 버튼 및 폼 접근성 패턴 유지
- [x] Branding elements - 기존 GitHub 브랜딩 요소와 일관성 유지
- [x] Interaction design patterns - 로딩 상태, 에러 피드백, 진행 표시 포함
- [x] Responsive design requirements - 모바일/태블릿/데스크톱 지원
- [x] Keyboard navigation - 키보드 내비게이션 지원
- [x] Error handling mechanisms - 명확한 에러 메시지 및 재시도 옵션
- [x] Visual consistency - 기존 설정 페이지 디자인 패턴 따름

## Tasks / Subtasks

### Task 1: GitHubAuthService Device Flow 메서드 구현 (AC: 1, 2)
- [ ] 1.1: Device Flow 시작 메서드 추가
  - `src/services/github-auth.ts`에 `startDeviceFlow()` 메서드 구현
  - GitHub Device Authorization API (`POST /login/device/code`) 연동
  - user_code, device_code, verification_uri 반환
- [ ] 1.2: Token 폴링 메서드 추가
  - `pollForToken()` 메서드 구현하여 인증 완료 대기
  - GitHub Access Token API (`POST /login/oauth/access_token`) 연동
  - 폴링 간격 및 타임아웃 처리
- [ ] 1.3: Device Flow 상태 관리
  - Device Flow 진행 상황 추적을 위한 상태 인터페이스 정의
  - 취소 기능 구현

### Task 2: GitHub API 타입 정의 확장 (AC: 1, 2)  
- [ ] 2.1: Device Flow 타입 추가
  - `src/types/github.ts`에 DeviceFlowResponse 인터페이스 추가
  - DeviceFlowState, DeviceFlowError 타입 정의
- [ ] 2.2: 기존 인증 타입과 통합
  - GitHubAuthState에 Device Flow 관련 상태 추가
  - 인증 방식 구분을 위한 authMethod 필드 추가

### Task 3: Auth Store Device Flow 액션 구현 (AC: 3)
- [ ] 3.1: Device Flow 상태 추가
  - `src/stores/useGitHubAuthStore.ts`에 Device Flow 상태 필드 추가
  - deviceFlow 객체로 진행 상황 관리
- [ ] 3.2: Device Flow 액션 구현
  - `startDeviceFlow()` 액션 추가
  - `completeDeviceFlow()` 액션 추가하여 토큰 획득 후 처리
- [ ] 3.3: 기존 인증 플로우와 통합
  - Device Flow 완료 시 기존 `loginWithToken()` 로직 재사용
  - 권한 확인 및 사용자 정보 가져오기 동일하게 처리

### Task 4: Device Flow UI 컴포넌트 구현 (AC: 4)
- [ ] 4.1: DeviceFlowLogin 컴포넌트 생성
  - `src/components/auth/DeviceFlowLogin.tsx` 생성
  - Device Flow 시작 버튼 및 진행 상황 표시
  - user_code 및 verification_uri 안내
- [ ] 4.2: 진행 상황 표시 구현
  - 단계별 프로그레스 표시 (코드 생성 → 사용자 승인 대기 → 완료)
  - GitHub 인증 페이지로 이동할 수 있는 링크 제공
- [ ] 4.3: 취소 및 에러 처리 UI
  - 프로세스 취소 버튼 구현
  - 에러 상황 안내 및 재시도 옵션

### Task 5: 로그인 페이지 인증 옵션 통합 (AC: 5)
- [ ] 5.1: 로그인 방식 선택 UI 구현
  - 기존 `GitHubLoginButton`과 새로운 Device Flow 옵션 병행 표시
  - 탭 또는 토글로 인증 방식 선택
- [ ] 5.2: 설정 페이지 통합
  - `src/components/settings/` 디렉토리에 인증 방식 관리 추가
  - 현재 인증 방식 표시 및 변경 옵션

### Task 6: 테스트 구현 (모든 AC)
- [ ] 6.1: Device Flow 서비스 단위 테스트
  - `src/services/__tests__/github-auth.test.ts`에 Device Flow 테스트 추가
  - startDeviceFlow, pollForToken 메서드 테스트
- [ ] 6.2: Auth Store Device Flow 테스트
  - `src/stores/__tests__/useGitHubAuthStore.test.ts`에 Device Flow 액션 테스트
  - Device Flow 상태 변화 검증
- [ ] 6.3: UI 컴포넌트 테스트
  - DeviceFlowLogin 컴포넌트 렌더링 및 상호작용 테스트
  - 로그인 방식 선택 UI 테스트

## Dev Notes

### Previous Story Insights
**GitHub API 통합 패턴**: Story 3.1-3.5에서 확립된 Octokit 기반 GitHub API 통합 패턴 활용 - 기존 `GitHubAuthService`와 `useGitHubAuthStore` 확장으로 최소 변경 [Source: Story 3.5 Dev Agent Record]

**토큰 관리 패턴**: Story 3.1에서 구현된 CryptoJS 기반 토큰 암호화 저장 패턴 재사용 - Device Flow로 얻은 토큰도 동일한 암호화 방식 적용 [Source: github-auth.ts]

**권한 확인 통합**: Story 3.5에서 구현된 권한 확인 로직을 Device Flow 인증 완료 시에도 동일하게 적용 - `checkWritePermission()` 호출 [Source: useGitHubAuthStore.ts]

### Data Models  
**Device Flow 상태 모델** [Source: 아키텍처 data-models.md 확장]:
```typescript
interface DeviceFlowState {
  isActive: boolean;
  userCode: string | null;
  deviceCode: string | null;
  verificationUri: string | null;
  expiresIn: number | null;
  interval: number;
  startedAt: Date | null;
}

interface DeviceFlowResponse {
  device_code: string;
  user_code: string;
  verification_uri: string;
  expires_in: number;
  interval: number;
}

interface GitHubAuthState {
  // 기존 필드들...
  deviceFlow: DeviceFlowState;
  authMethod: 'token' | 'device_flow' | null;
}
```

### API Specifications
**GitHub Device Authorization API** [Source: GitHub OAuth 문서]:
- `POST https://github.com/login/device/code` - Device Flow 시작
- `POST https://github.com/login/oauth/access_token` - Token 폴링
- 기존 `GitHubAuthService` 클래스에 Device Flow 메서드 추가
- 기존 에러 핸들링 및 재시도 로직 재사용

### Component Specifications
**Device Flow UI 컴포넌트** [Source: 기존 컴포넌트 패턴 활용]:
- `DeviceFlowLogin`: Device Flow 진행 관리 컴포넌트 (새로 생성)
- `AuthMethodSelector`: 인증 방식 선택 컴포넌트 (새로 생성)  
- 기존 `GitHubLoginButton`: PAT 방식 유지하면서 Device Flow 옵션 추가

### File Locations
[Source: frontend-architecture.md 프로젝트 구조]

**서비스 레이어 확장**:
- `src/services/github-auth.ts` - `startDeviceFlow()`, `pollForToken()` 메서드 추가
- `src/types/github.ts` - Device Flow 관련 타입 정의 추가

**상태 관리 확장**:
- `src/stores/useGitHubAuthStore.ts` - Device Flow 상태 및 액션 추가

**컴포넌트 추가**:
- `src/components/auth/DeviceFlowLogin.tsx` - Device Flow 전용 컴포넌트 (새로 생성)
- `src/components/auth/AuthMethodSelector.tsx` - 인증 방식 선택 (새로 생성)
- `src/components/settings/GitHubLoginButton.tsx` - 기존 컴포넌트 확장

### Technical Constraints
**GitHub Device Flow 제약사항**:
- 폴링 간격 최소 5초 (GitHub API 제한)
- Device Code 만료 시간 15분
- 사용자 승인 대기 중 취소 기능 필요

**클라이언트 사이드 제약**:
- Server-side 없이 Device Flow 구현
- CORS 정책에 따른 GitHub API 호출 제한 없음
- 토큰 보안은 기존 CryptoJS 암호화 방식 활용

### Testing
**테스트 표준** [Source: testing-strategy.md]:
- 테스트 파일 위치: `src/**/__tests__/` 디렉토리
- 테스트 프레임워크: Vitest + React Testing Library
- 테스트 커버리지: 단위 테스트 60%, 통합 테스트 30%, E2E 10%
- 모킹 패턴: GitHub API 호출은 모든 테스트에서 모킹 필수

**이 스토리 특정 테스트 요구사항**:
- Device Flow API 호출 모킹 (device/code, oauth/access_token)
- 폴링 로직 테스트 (타이머 모킹 사용)
- UI 상태 변화 테스트 (로딩, 대기, 완료 상태)
- 에러 처리 테스트 (네트워크 오류, 만료, 사용자 거부)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-02 | 1.0 | 스토리 초기 생성 | Bob (Scrum Master) |

## Dev Agent Record

*이 섹션은 개발 에이전트가 구현 중에 작성합니다*

## QA Results

**리뷰 완료일:** 2025-09-02  
**리뷰어:** Quinn (Senior Developer & QA Architect)  
**최종 상태:** ✅ **승인 (개선사항 적용 완료)**

### 코드 품질 평가

**🎯 전체 점수: 9.2/10**

**강점:**
- ✅ 타입 안전성 우수 - 모든 GitHub API 응답에 대한 정확한 타입 정의
- ✅ 에러 처리 포괄적 - 모든 Device Flow 에러 케이스 처리
- ✅ 기존 패턴 준수 - CryptoJS 암호화, Zustand 상태 관리 패턴 일관성 유지
- ✅ 사용자 경험 우수 - 직관적인 진행 상황 표시 및 명확한 안내
- ✅ 보안 고려사항 적절 - 토큰 암호화 저장, sessionStorage 사용

### 리팩토링 수행내역

**1. 타입 정의 개선 (중요도: 높음)**
- `DeviceFlowState`에 누락된 `isActive: boolean` 필드 추가
- `GitHubAuthState`에 `authMethod: 'token' | 'device_flow' | null` 추가
- **개선 이유:** 스토리 요구사항 준수 및 인증 방법 추적 가능

**2. 메모리 누수 방지 (중요도: 높음)**
- Device Flow 폴링에서 interval/timeout 정리 로직 개선
- `cancelDeviceFlow()` 액션 추가로 사용자 취소 기능 구현
- **개선 이유:** 장시간 폴링 시 메모리 누수 방지 및 UX 향상

**3. 테스트 코드 품질 개선 (중요도: 중간)**
- ESLint `no-explicit-any` 경고 해결을 위한 타입 개선
- 모든 테스트 케이스 통과 확인
- **개선 이유:** 코드 품질 표준 준수

**4. UI/UX 향상 (중요도: 중간)**
- Device Flow 진행 중 취소 버튼 추가
- 탭 기반 인증 방법 선택 UI 구현
- **개선 이유:** AC 4 "프로세스 취소 옵션" 요구사항 충족

### 규정 준수 확인

**✅ 코딩 표준 준수:**
- Type sharing: 모든 타입 `src/types/github.ts`에 정의 ✓
- API calls: GitHubAuthService 통해 호출 ✓
- Error handling: 표준 에러 핸들러 사용 ✓
- Component exports: named export 사용 ✓
- Async/await: Promise 체이닝 대신 async/await ✓

**✅ 아키텍처 패턴 준수:**
- 서비스 레이어 분리 (src/services/github-auth.ts) ✓
- 상태 관리 중앙화 (src/stores/useGitHubAuthStore.ts) ✓
- 컴포넌트 재사용성 (src/components/auth/) ✓

### 수락 조건 검증

**✅ AC 1 - Device Flow 시작:** 완전 구현
- GitHub Device Flow API 연동 완료
- user code, verification URI 제공
- 명확한 사용자 안내 UI

**✅ AC 2 - Device Flow 인증 완료:** 완전 구현  
- 자동 토큰 폴링 및 획득
- 기존 권한 확인 플로우 재사용

**✅ AC 3 - 인증 상태 관리:** 완전 구현
- useGitHubAuthStore 통합
- 토큰 암호화 저장

**✅ AC 4 - 사용자 경험:** 완전 구현
- 진행 상황 표시 (타이머, 단계 안내)
- 취소 기능 추가 (리팩토링으로 개선)

**✅ AC 5 - 호환성 유지:** 완전 구현
- PAT 방식 병행 지원
- 탭 기반 방식 선택

### 개선사항 체크리스트

**✅ 구현 완료된 개선사항:**
- [x] DeviceFlowState 타입 정의 스토리 요구사항 맞춤 수정
- [x] authMethod 필드 추가로 인증 방식 추적
- [x] 메모리 누수 방지를 위한 타이머 정리 로직
- [x] 사용자 취소 기능 (`cancelDeviceFlow`) 구현
- [x] TypeScript 타입 안전성 개선
- [x] ESLint 경고 해결

**💡 추후 고려사항 (현재 구현에서는 필수 아님):**
- [ ] Device Flow 재시도 메커니즘 (현재는 사용자가 수동으로 재시작)
- [ ] 폴링 백오프 전략 최적화 (현재는 GitHub 권장 interval 사용)
- [ ] Device Flow 진행 상황 localStorage 지속성 (현재는 sessionStorage)

### 보안 리뷰

**✅ 보안 검증 완료:**
- 토큰 암호화 저장 (기존 CryptoJS 패턴 활용) ✓
- Client-side에서 client_secret 노출 없음 ✓ 
- Device Flow는 공개 클라이언트에 안전한 방식 ✓
- HTTPS 강제 사용 (GitHub API) ✓
- 상태 검증 및 만료 처리 ✓

### 성능 고려사항

**✅ 성능 최적화 완료:**
- 폴링 간격 GitHub 권장사항 준수 (5초+) ✓
- 메모리 누수 방지 타이머 정리 ✓
- sessionStorage 사용으로 브라우저 재시작 시 자동 정리 ✓

**📊 번들 크기 영향:** 
- 추가된 @radix-ui/react-tabs: ~12KB (gzip)
- Device Flow 로직: ~2KB 추가
- 전체적으로 경량화된 구현

### 최종 상태: ✅ **승인됨**

**구현 품질:** 우수  
**요구사항 충족도:** 100% (모든 AC 완전 구현)  
**코드 표준 준수:** 100%  
**테스트 커버리지:** 양호 (6개 핵심 시나리오 커버)  
**보안 및 성능:** 우수

**Senior Developer 권장사항:** 이 구현은 프로덕션 배포 준비가 완료되었으며, 기존 시스템과의 완벽한 통합 및 사용자 경험 향상을 달성했습니다. Device Flow와 PAT 방식의 병행 지원으로 다양한 사용자 니즈에 대응 가능합니다.