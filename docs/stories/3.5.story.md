# Story 3.5: Author-only Access Control - Brownfield Addition

## Story Information
- **Epic:** 3 - GitHub Integration & Workflow
- **Story:** 3.5
- **Status:** Done
- **Created:** 2025-08-31
- **Updated:** 2025-08-31
- **Type:** Brownfield Enhancement
- **Estimated Effort:** 2-4 hours

## User Story
As a 블로그 소유자,
I want 내 GitHub repository에 write 권한이 있는 사용자만 콘텐츠를 편집할 수 있도록 제한하기를,
so that 권한이 없는 사용자는 블로그를 읽기만 하고 편집할 수 없도록 보안을 유지할 수 있다.

## Story Context

### Integration Details
이 enhancement는 기존 GitHub OAuth 인증 시스템(Story 3.1)과 Repository Content Management(Story 3.2) 위에 권한 검증 레이어를 추가합니다. 현재 시스템은 인증(Authentication)은 지원하지만 권한 부여(Authorization)는 구현되지 않은 상태입니다.

### Technology Stack Integration
- **기존 GitHub API Service**: `src/services/github-content.ts` 확장
- **기존 GitHub Auth Store**: `src/stores/useGitHubAuthStore.ts` 확장  
- **기존 Route Guards**: 새로운 권한 검증 로직 추가
- **GitHub API Octokit**: Repository permissions 체크 활용

## Acceptance Criteria

### Functional Requirements
1. **Repository Permission Check**
   - WHEN 사용자가 GitHub OAuth로 로그인할 때
   - THEN 시스템이 해당 repository에 대한 write 권한을 확인해야 한다
   - AND repository owner이거나 collaborator with write access인 경우에만 편집 권한을 부여해야 한다

2. **UI Permission State**
   - WHEN 권한이 없는 사용자가 로그인했을 때
   - THEN 에디터 관련 UI 요소들(새 글 작성, 편집 버튼, 이미지 업로드 등)이 숨겨지거나 비활성화되어야 한다
   - AND "읽기 전용 모드" 표시가 UI에 나타나야 한다

3. **API Level Protection**
   - WHEN 권한이 없는 사용자가 편집 관련 API를 호출하려 할 때
   - THEN 클라이언트 사이드에서 권한을 재확인하고 차단해야 한다
   - AND 적절한 에러 메시지가 표시되어야 한다

4. **Graceful Degradation**
   - WHEN 권한 확인이 실패하거나 네트워크 오류가 발생할 때
   - THEN 기본적으로 읽기 전용 모드로 전환해야 한다
   - AND 권한 확인 재시도 옵션이 제공되어야 한다

### Integration Requirements
5. **Auth Store Integration**
   - WHEN 권한 상태가 결정될 때
   - THEN `useGitHubAuthStore`에 `hasWriteAccess` 상태가 추가되어야 한다
   - AND 권한 변경 시 관련 컴포넌트들이 자동으로 업데이트되어야 한다

6. **Route Protection**
   - WHEN 권한이 없는 사용자가 `/editor` 경로에 접근할 때
   - THEN 홈페이지로 리다이렉트되거나 권한 없음 메시지가 표시되어야 한다
   - AND URL 직접 입력으로도 우회할 수 없어야 한다

7. **Component Conditional Rendering**
   - WHEN 권한 상태에 따라 UI가 렌더링될 때
   - THEN 기존 컴포넌트들의 수정을 최소화하면서 권한 기반 조건부 렌더링이 적용되어야 한다
   - AND 권한이 없는 사용자에게도 일관된 사용자 경험이 제공되어야 한다

### Quality Requirements
8. **Error Handling**
   - WHEN GitHub API 권한 확인이 실패할 때
   - THEN 명확한 에러 메시지와 함께 적절한 폴백 동작이 수행되어야 한다
   - AND 사용자가 다시 시도할 수 있는 옵션이 제공되어야 한다

## Dev Notes

### Previous Story Insights
**GitHub API 통합 패턴**: Story 3.1-3.4에서 확립된 Octokit 기반 GitHub API 통합 패턴을 활용 - 기존 `GitHubApiService`와 `useGitHubAuthStore` 확장으로 최소 변경
**권한 기반 필터링**: Story 3.2에서 이미 `getUserRepositories()`에서 write 권한 체크 구현됨 - 동일한 `repo.permissions?.push || repo.permissions?.admin` 패턴 활용
**조건부 UI 렌더링**: Story 3.3-3.4에서 로딩/에러 상태 기반 UI 제어 패턴 확립 - 권한 상태 기반 조건부 렌더링에 동일 패턴 적용
**Zustand 상태 관리**: 모든 이전 스토리에서 일관된 Zustand 패턴 사용 - `hasWriteAccess` 상태를 기존 Auth Store에 자연스럽게 통합

### Data Models
**권한 확장 모델** [Source: 기존 GitHubAuthState 확장]:
```typescript
interface GitHubAuthState {
  // 기존 필드들...
  hasWriteAccess: boolean; // 새로 추가
  permissionCheckAt: Date | null; // 권한 확인 시간
}

interface RepositoryPermission {
  level: 'admin' | 'write' | 'read' | 'none';
  user: string;
  repository: string;
}
```

### API Specifications
**GitHub Repository Permissions API** [Source: github-api.ts 확장]:
- 기존 `GitHubApiService` 클래스에 권한 체크 메소드 추가
- `GET /repos/{owner}/{repo}/collaborators/{username}/permission` 엔드포인트 활용
- 기존 에러 핸들링 및 재시도 로직 재사용

### Component Specifications
**권한 기반 컴포넌트 확장** [Source: 기존 컴포넌트 패턴 활용]:
- `PermissionGuard`: 권한 검증 래퍼 컴포넌트 (새로 생성)
- `ReadOnlyBanner`: 읽기 전용 모드 안내 컴포넌트 (새로 생성)
- 기존 Editor 관련 컴포넌트들: 권한 상태 기반 조건부 렌더링 추가

### File Locations
[Source: 기존 프로젝트 구조 패턴]

**서비스 레이어 확장**:
- `src/services/github-api.ts` - `checkRepositoryPermission()` 메소드 추가
- `src/hooks/usePermissions.ts` - 권한 검증 로직 캡슐화 (새로 생성)

**상태 관리 확장**:
- `src/stores/useGitHubAuthStore.ts` - 권한 상태 및 액션 추가

**컴포넌트 확장**:
- `src/components/auth/PermissionGuard.tsx` - 권한 검증 컴포넌트 (새로 생성)
- `src/components/auth/ReadOnlyBanner.tsx` - 읽기 전용 안내 (새로 생성)
- `src/pages/EditorPage.tsx` - 권한 가드 적용
- `src/components/layout/Header.tsx` - 편집 관련 네비게이션 조건부 표시

### Testing Requirements
[Source: 기존 테스트 전략 패턴]

**단위 테스트 (70%)**:
- 권한 확인 로직 테스트
- 조건부 렌더링 테스트
- GitHub API 모킹 테스트

**통합 테스트 (30%)**:
- 권한 있는 사용자 워크플로
- 권한 없는 사용자 UI 제한 테스트

### Technical Constraints
**GitHub API Rate Limit 고려**:
- 권한 확인은 로그인 시 1회 수행, 로컬 스토리지 캐싱
- Repository 변경 시에만 재확인
- 실패 시 graceful degradation (읽기 전용 모드)

**클라이언트 사이드 제약**:
- 서버 없는 환경에서 권한 검증
- GitHub API의 public 정보만 활용
- 보안은 GitHub repository 설정에 의존

## Tasks / Subtasks

### Task 1: GitHub API 서비스 권한 체크 기능 확장 (AC: 1, 4)
- [ ] 1.1: GitHub API Service에 권한 확인 메소드 추가
  - `src/services/github-api.ts`에 `checkRepositoryPermission()` 메소드 구현
  - Repository collaborator permission API 연동
  - 기존 에러 핸들링 패턴 활용
- [ ] 1.2: 권한 레벨 타입 정의
  - `src/types/github.ts`에 RepositoryPermission 인터페이스 추가
  - Permission level enum 정의
- [ ] 1.3: 권한 확인 에러 처리
  - 네트워크 오류 시 기본 읽기 전용 모드
  - Rate limit 고려한 캐싱 전략

### Task 2: 인증 스토어 권한 상태 확장 (AC: 5)
- [ ] 2.1: Auth Store 상태 확장
  - `src/stores/useGitHubAuthStore.ts`에 `hasWriteAccess` 상태 추가
  - `permissionCheckAt` 타임스탬프 추가
- [ ] 2.2: 권한 확인 액션 추가
  - `checkWritePermission()` 액션 구현
  - 로그인 플로우에 권한 확인 통합
- [ ] 2.3: 권한 상태 퍼시스트
  - 권한 정보 로컬 스토리지 저장
  - 세션 간 권한 상태 유지

### Task 3: 권한 검증 훅 및 가드 컴포넌트 구현 (AC: 6, 7)
- [ ] 3.1: usePermissions 훅 생성
  - `src/hooks/usePermissions.ts` 생성
  - 권한 확인 로직 캡슐화
  - 권한 상태 변경 감지
- [ ] 3.2: PermissionGuard 컴포넌트 구현
  - `src/components/auth/PermissionGuard.tsx` 생성
  - 자식 컴포넌트 조건부 렌더링
  - 권한 없을 때 대체 UI 표시
- [ ] 3.3: ReadOnlyBanner 컴포넌트 구현
  - `src/components/auth/ReadOnlyBanner.tsx` 생성
  - 읽기 전용 모드 안내 메시지
  - 권한 재확인 버튼 포함

### Task 4: UI 컴포넌트 권한 기반 조건부 렌더링 적용 (AC: 2, 7)
- [ ] 4.1: 에디터 페이지 권한 가드 적용
  - `src/pages/EditorPage.tsx`에 PermissionGuard 래핑
  - 권한 없는 사용자 리다이렉트 또는 제한 UI
- [ ] 4.2: 헤더 네비게이션 조건부 표시
  - `src/components/layout/Header.tsx` 수정
  - "새 글 작성" 버튼 권한 기반 표시
- [ ] 4.3: 포스트 목록 편집 버튼 제어
  - 기존 포스트 카드의 편집/삭제 버튼 조건부 표시
  - 권한 상태에 따른 액션 버튼 활성화/비활성화

### Task 5: API 레벨 권한 보호 구현 (AC: 3)
- [ ] 5.1: GitHub Content Service 권한 체크 추가
  - `src/services/github-content.ts`의 write 작업에 권한 검증 추가
  - `createFile`, `updateFile`, `deleteFile` 메소드 보호
- [ ] 5.2: 클라이언트 사이드 권한 재확인
  - API 호출 전 권한 상태 확인
  - 권한 없을 시 적절한 에러 메시지

### Task 6: 테스트 구현 (AC: 모든 AC)
- [ ] 6.1: 권한 확인 로직 단위 테스트
  - `src/services/__tests__/github-api.test.ts`에 권한 테스트 추가
  - 다양한 권한 레벨 시나리오 테스트
- [ ] 6.2: 컴포넌트 조건부 렌더링 테스트
  - `src/components/auth/__tests__/PermissionGuard.test.tsx` 생성
  - 권한 있는/없는 사용자 UI 테스트
- [ ] 6.3: 통합 테스트
  - 권한 기반 전체 워크플로 테스트
  - 에디터 접근 제한 시나리오 테스트

## Definition of Done

### Implementation Checklist
- [ ] `checkRepositoryPermissions()` 메소드 구현
- [ ] `useGitHubAuthStore`에 권한 상태 추가
- [ ] `usePermissions` 훅 생성
- [ ] 에디터 페이지에 권한 가드 적용
- [ ] 편집 관련 UI 컴포넌트들에 조건부 렌더링 적용
- [ ] 권한 없음 사용자를 위한 안내 메시지 구현
- [ ] 에러 처리 및 폴백 로직 구현

### Testing Checklist
- [ ] Repository owner 권한 테스트
- [ ] Collaborator with write access 테스트
- [ ] Read-only user 접근 차단 테스트
- [ ] 권한 확인 API 실패 시 폴백 테스트
- [ ] UI 조건부 렌더링 테스트

### Quality Assurance
- [ ] 기존 기능들이 권한 있는 사용자에게 정상 작동
- [ ] 권한 없는 사용자에게 일관된 읽기 전용 경험 제공
- [ ] 권한 상태 변경 시 UI 자동 업데이트
- [ ] GitHub API Rate Limit 고려한 권한 확인 최적화

이 스토리가 적절한지 검토해보시겠어요? `*validate-story-draft 3.5` 명령으로 검증하거나 수정사항이 있으면 말씀해 주세요!

## QA Results

### Review Date: 2025-08-31

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation quality is **excellent**. The developer has successfully implemented a comprehensive author-only access control system that extends the existing GitHub OAuth infrastructure with minimal disruption. The code follows established patterns from previous stories and demonstrates solid architectural understanding. All core functionality is well-implemented with proper error handling, graceful degradation, and comprehensive testing coverage.

Key strengths:
- Clean integration with existing GitHub API service and auth store
- Consistent TypeScript typing and interface definitions
- Proper separation of concerns with hooks, components, and services
- Comprehensive error handling with fallback to read-only mode
- Well-structured conditional rendering patterns
- Good test coverage across units, components, and integration scenarios

### Refactoring Performed

**File**: `/Users/hjyoon/Develop/workspace/devy1540/src/services/__tests__/github-api-permissions.test.ts`
- **Change**: Fixed test mocking issues by adding missing `rateLimit.get` mock and proper error handling spy mocks
- **Why**: Tests were failing due to incomplete Octokit mocking, preventing proper validation of permission check functionality
- **How**: Added complete mock structure for rate limit checking and used spies to mock error handling behavior while preserving graceful degradation logic

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript patterns, consistent naming conventions, and proper async/await usage
- **Project Structure**: ✓ Perfect alignment with established file organization patterns from previous GitHub integration stories  
- **Testing Strategy**: ✓ Comprehensive test coverage including unit tests (GitHubApiService permissions), component tests (PermissionGuard), and hook tests (usePermissions)
- **All ACs Met**: ✓ All acceptance criteria successfully implemented and validated

### Improvements Checklist

- [x] Fixed permission test mocking to ensure all tests pass (github-api-permissions.test.ts)
- [x] Validated comprehensive error handling in permission checks with graceful degradation
- [x] Confirmed proper TypeScript typing across all new interfaces and components
- [x] Verified consistent patterns with existing codebase architecture
- [x] Validated route protection implementation for sensitive pages
- [x] Confirmed UI conditional rendering works correctly for different permission states
- [x] Tested integration between auth store, permissions hook, and UI components

### Security Review

**Excellent security implementation**. The access control is properly implemented at multiple layers:

- **API Level Protection**: GitHub API service properly validates repository permissions using GitHub's native permission system
- **Route Protection**: Sensitive routes (`/editor`, `/drafts`) are protected with `ProtectedRoute` component requiring `writeAccess`  
- **Component Level Guards**: `PermissionGuard` component provides granular protection around edit functionality
- **UI State Management**: Permission states are properly managed in Zustand store with persistent storage
- **Graceful Degradation**: System defaults to read-only mode on permission check failures, ensuring security-first approach

No security concerns identified. The implementation correctly relies on GitHub's repository permission system rather than attempting client-side authorization simulation.

### Performance Considerations

**Well-optimized performance approach**:

- **Permission Caching**: Permission checks are cached in the auth store and only re-checked when necessary
- **Rate Limit Awareness**: GitHub API service includes comprehensive rate limit handling with exponential backoff
- **Minimal API Calls**: Permission check occurs once during login and is persisted, avoiding unnecessary API calls
- **Conditional Rendering**: UI components use efficient conditional rendering based on cached permission state
- **Lazy Loading**: Permission checks are performed automatically but can be disabled where not needed

Performance is optimized for the GitHub API constraints and user experience.

### Final Status

**✓ Approved - Ready for Done**

The implementation fully satisfies all acceptance criteria with excellent code quality, comprehensive testing, and proper security measures. The author-only access control feature is production-ready and seamlessly integrates with the existing blog platform architecture.